version: '3'

tasks:
  simple-setup:
    deps: [install-deps, build-all, push-exec-short-image, push-exec-long-image, push-proc-image, deploy, install-cli, setup-ci]

  test:
    deps: [test-core, test-exec, test-proc]

  test-core:
    cmds:
      - dotnet test --filter "FullyQualifiedName~test.unit"

  test-proc:
    deps: [build-proc-image]
    cmds:
      - |
        rm -rf test/pwnctl.proc.test.int/bin
        export UNTESTED_IMAGE=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-proc") | .repositoryUri'):untested_$(git rev-parse --short HEAD)
        dotnet test --filter "FullyQualifiedName~pwnctl.proc"

  test-exec:
    deps: [build-exec-long-image]
    cmds:
    - |
      rm -rf test/pwnctl.exec.test.int/bin
      export UNTESTED_IMAGE=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-long") | .repositoryUri'):untested_$(git rev-parse --short HEAD)
      dotnet test --filter "FullyQualifiedName~pwnctl.exec"

  build-api:
    cmds:
      - dotnet build src/pwnctl.api/pwnctl.api.csproj -c Release

  build-cli:
    cmds:
      - dotnet publish src/pwnctl.cli/pwnctl.cli.csproj -c Release

  build-exec-short-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-short") | .repositoryUri')
        docker buildx build --ssh default=$SSH_AUTH_SOCK src/core/ -f src/core/pwnctl.exec/shortlived/Dockerfile -t ${ecrUri}:$commitHash
        docker tag ${ecrUri}:$commitHash ${ecrUri}:untested_$commitHash

  build-exec-long-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-long") | .repositoryUri')
        docker buildx build --ssh default=$SSH_AUTH_SOCK src/core/ -f src/core/pwnctl.exec/longlived/Dockerfile -t ${ecrUri}:$commitHash
        docker tag ${ecrUri}:$commitHash ${ecrUri}:untested_$commitHash

  push-exec-short-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        region=$(aws configure get region)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-short") | .repositoryUri')
        aws ecr get-login-password --region $region \
          | docker login --username AWS --password-stdin ${ecrUri}
        docker push ${ecrUri}:$commitHash

  push-exec-long-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        region=$(aws configure get region)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-long") | .repositoryUri')
        aws ecr get-login-password --region $region \
          | docker login --username AWS --password-stdin ${ecrUri}
        docker push ${ecrUri}:$commitHash

  build-proc-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-proc") | .repositoryUri')
        docker build src/core/ -f src/core/pwnctl.proc/Dockerfile -t ${ecrUri}:$commitHash
        docker tag ${ecrUri}:$commitHash ${ecrUri}:untested_$commitHash

  push-proc-image:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        region=$(aws configure get region)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-proc") | .repositoryUri')
        aws ecr get-login-password --region $region \
          | docker login --username AWS --password-stdin $ecrUri
        docker push ${ecrUri}:$commitHash

  build-all:
    deps: [build-cli, build-api, build-exec-short-image, build-exec-long-image, build-proc-image]

  install-cli:
    deps: [build-cli]
    cmds:
      - chmod +x src/pwnctl.cli/bin/Release/net7.0/linux-x64/publish/pwnctl
      - mv src/pwnctl.cli/bin/Release/net7.0/linux-x64/publish/pwnctl ~/.local/bin
      - mkdir -p ~/.config/pwnctl/
      - chown $USER ~/.config/pwnctl/
      - mv src/pwnctl.cli/bin/Release/net7.0/linux-x64/publish/config.ini ~/.config/pwnctl/
      - ./src/core/pwnctl.exec/scripts/get-psl.sh ~/.config/pwnctl/
      - cp -r ./src/core/pwnctl.infra/Persistence/seed ~/.config/pwnctl

  setup-ci:
    cmds:
      - gh variable set AWS_REGION --body "$(aws configure get region)"
      - gh variable set AWS_CALLER_IDENTITY --body "$(aws sts get-caller-identity | jq -r .Account)"
      - terraform -chdir=infra/modules/ci apply -auto-approve

  deploy:
    deps: [setup-ci, build-api, install-cli]
    cmds:
      - terraform -chdir=infra apply -auto-approve
      - ./bin/upload-conf.sh

  destroy:
    cmds:
      - ./bin/teardown.sh

  destroy-ci:
    cmds:
      - terraform -chdir=infra/modules/ci destroy

  debug-exec-long:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-long") | .repositoryUri')
        docker run -e PWNCTL_USE_LOCAL_INTEGRATIONS=true -e PWNCTL_INSTALL_PATH=/mnt/efs \
                   -e PWNCTL_Logging__FilePath=/mnt/efs -e PWNCTL_Logging__MinLevel=Information \
                   -e PWNCTL_TaskQueue__VisibilityTimeout=1200 -e PWNCTL_OutputQueue__VisibilityTimeout=1200 \
                   -v "$(pwd)"/deployment:/mnt/efs -t ${ecrUri}:$commitHash

  debug-exec-short:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-exec-short") | .repositoryUri')
        docker run -e PWNCTL_USE_LOCAL_INTEGRATIONS=true -e PWNCTL_INSTALL_PATH=/mnt/efs \
                   -e PWNCTL_Logging__FilePath=/mnt/efs -e PWNCTL_Logging__MinLevel=Information \
                   -e PWNCTL_TaskQueue__VisibilityTimeout=1200 -e PWNCTL_OutputQueue__VisibilityTimeout=1200 \
                   -v "$(pwd)"/deployment:/mnt/efs -t ${ecrUri}:$commitHash

  debug-proc:
    cmds:
      - |
        commitHash=$(git rev-parse --short HEAD)
        mkdir -p deployment/seed/
        cp ./src/core/pwnctl.infra/Persistence/seed/*.yml deployment/seed/
        ecrUri=$(aws ecr describe-repositories | jq -r '.repositories[] | select( .repositoryName == "pwnctl-proc") | .repositoryUri')
        docker run -e PWNCTL_USE_LOCAL_INTEGRATIONS=true -e PWNCTL_INSTALL_PATH=/mnt/efs \
                   -e PWNCTL_Logging__FilePath=/mnt/efs -e PWNCTL_Logging__MinLevel=Information \
                   -e PWNCTL_TaskQueue__VisibilityTimeout=1200 -e PWNCTL_OutputQueue__VisibilityTimeout=1200 \
                   -v "$(pwd)"/deployment:/mnt/efs -t ${ecrUri}:$commitHash

  get-exec-logs:
    cmds:
      - awslogs get -s 1440m -G --timestamp /aws/ecs/exec

  get-proc-logs:
    cmds:
      - awslogs get -s 1440m -G --timestamp /aws/ecs/proc

  get-api-logs:
    cmds:
      - |
        functionName=$(aws lambda list-functions | jq -r '.Functions[] | select( .FunctionName | startswith("pwnctl_api") ) | .FunctionName')
        awslogs get -s 1440m -G --timestamp /aws/lambda/$functionName

  install-deps:
    cmds:
      - ./bin/install-deps.sh
